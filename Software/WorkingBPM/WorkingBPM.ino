/*
  WorkingBPM

  This code is capable of processing BPM values from a pulse sensor and displaying the values on
  a LCD screen display.

  modified 11 Nov 2018
  by Haeryn Kim
  
  http://github.com/haerynkim/FlashlightRepos
*/
#define USE_ARDUINO_INTERRUPTS true
#include <PulseSensorPlayground.h>
#include <Wire.h>
#include <SeeedOLED.h>

// Define constants:
const int interruptPin = 2;
int PWM_max = 255;
int ledPin = 3;
const int PULSE_INPUT = 0;
static const unsigned char myLogo[] PROGMEM ={
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0x7f, 0x2f, 0x27, 0xb7, 0xb7, 0x87, 0xcf, 0xff, 0x0f, 0x07, 0x07, 0xf7, 0x07, 0x07, 0x0f, 0xff, 
  0xef, 0x07, 0x07, 0xff, 0xff, 0x4f, 0x07, 0x07, 0xb7, 0x07, 0x07, 0x4f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 
  0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xf3, 0xe7, 0xcf, 0xdf, 0xff, 0x7f, 0x7f, 
  0x3f, 0x9f, 0x9f, 0xcf, 0xcf, 0xcf, 0xef, 0xec, 0xef, 0xcf, 0xcf, 0xcf, 0x9f, 0x01, 0x01, 0x01, 
  0x01, 0x7f, 0xff, 0xff, 0xff, 0x01, 0x01, 0x01, 0x01, 0xff, 0x0f, 0x07, 0x07, 0x07, 0xf7, 0xf7, 
  0xf7, 0xf7, 0x07, 0x07, 0x07, 0x07, 0xff, 0x0f, 0x07, 0x07, 0x07, 0xf7, 0x37, 0x37, 0x37, 0x07, 
  0x07, 0x0f, 0xff, 0xff, 0x07, 0x07, 0x07, 0x07, 0xf7, 0xf7, 0xf7, 0x87, 0x07, 0x07, 0xcf, 0xff, 
  0xff, 0xc7, 0x07, 0x07, 0x3f, 0x3f, 0x3f, 0x3f, 0x07, 0x07, 0x07, 0x07, 0xff, 0x07, 0x07, 0x07, 
  0x07, 0xf7, 0xf7, 0xf7, 0xf7, 0x07, 0x07, 0x07, 0x0f, 0xff, 0xe1, 0xe1, 0xe1, 0xf1, 0xff, 0xcf, 
  0xcf, 0xc7, 0xc7, 0xd7, 0xd7, 0xd7, 0xd7, 0x17, 0x17, 0x17, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xbf, 0x3f, 0x3f, 0x3f, 0x3f, 0x3f, 0xbf, 0xff, 0xff, 0xff, 0x0f, 0x83, 0xf8, 0xfc, 0xfe, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc, 0xfc, 
  0x0c, 0x00, 0x02, 0x0e, 0xfe, 0xfc, 0xfc, 0xfc, 0xfc, 0xff, 0xfe, 0xfc, 0xfc, 0x8c, 0x8d, 0x8d, 
  0xff, 0xff, 0x7c, 0x1c, 0x1c, 0x1c, 0x9f, 0x9e, 0x9c, 0x1c, 0x1c, 0x1d, 0x1d, 0xfd, 0xfd, 0x0d, 
  0x0d, 0x0f, 0x9f, 0x9f, 0x9c, 0x9c, 0x1c, 0x1c, 0x1f, 0x7f, 0xff, 0xff, 0x9f, 0x0f, 0x0f, 0x0f, 
  0x0f, 0x9f, 0x9d, 0x9d, 0x9d, 0x9d, 0x9d, 0xfd, 0x0c, 0x0c, 0x0c, 0x0e, 0x9f, 0x9c, 0x9c, 0x9c, 
  0x1c, 0x1f, 0x3f, 0x7f, 0xff, 0x7c, 0x3c, 0x1c, 0x1c, 0x9f, 0x9f, 0x9f, 0x9f, 0x1f, 0x1f, 0x3e, 
  0x7e, 0xfc, 0x1c, 0x1d, 0x1d, 0x1d, 0xfd, 0xfc, 0xfc, 0xfc, 0x1e, 0x1f, 0x1f, 0x3f, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x83, 0x3f, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xdf, 0x0f, 0x0f, 0x9f, 0x9f, 0x9f, 0x0f, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0x60, 0x00, 0x80, 0xe0, 0xef, 0xef, 0xef, 0xe0, 0xe0, 0xe0, 0xe0, 0xff, 0xff, 0xe0, 0xe0, 0xe0, 
  0xff, 0xff, 0xfc, 0xec, 0xec, 0xec, 0xed, 0xed, 0xef, 0xe0, 0xe0, 0xe0, 0xf0, 0xff, 0xff, 0xe0, 
  0xe0, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xe0, 0xe0, 0xe0, 0xe0, 0xff, 0xff, 0xff, 0xf0, 0xe0, 0xe0, 
  0xe0, 0xef, 0xef, 0xe1, 0xe1, 0xe1, 0xf1, 0xff, 0xe0, 0xe0, 0xe0, 0xe0, 0xef, 0xef, 0xef, 0xef, 
  0xe0, 0xf0, 0xf0, 0xf0, 0xff, 0xf0, 0xe0, 0xe0, 0xe0, 0xef, 0xef, 0xef, 0xef, 0xe0, 0xe0, 0xf0, 
  0xf0, 0xff, 0xe1, 0xe1, 0xe1, 0xe0, 0xfe, 0xfe, 0xfe, 0xfe, 0xe0, 0xe1, 0xe1, 0xe1, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xcf, 0xe7, 0xf3, 0xf3, 0xff, 0xff, 0xff, 0xfe, 0xfc, 0xf9, 
  0xe3, 0x07, 0x1f, 0xff, 0xfe, 0x80, 0xcf, 0xff, 0x81, 0xf0, 0xff, 0x7f, 0x1f, 0x87, 0xf1, 0xf8, 
  0xfc, 0xfe, 0xff, 0xff, 0xfb, 0xf3, 0xe7, 0xcf, 0x9f, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xfb, 0x98, 0xd9, 0xd9, 0xcd, 0xcc, 0x6c, 0x6e, 0x66, 0x66, 0x36, 0x37, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x3f, 0x7f, 0xff, 0xff, 0x1f, 0x7f, 0xbf, 0x7f, 0xff, 0xff, 0xff, 0xbf, 
  0x7f, 0xff, 0xff, 0x7f, 0xff, 0x3f, 0xff, 0xff, 0xff, 0x7f, 0xbf, 0xff, 0x7f, 0xbf, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x1f, 0xbf, 0xff, 0x7f, 0xbf, 0x7f, 0xff, 0xff, 0xff, 0xff, 0x1f, 0x1f, 0xff, 
  0xff, 0x7f, 0x9f, 0xff, 0xff, 0x7f, 0xbf, 0x3f, 0xff, 0xbf, 0x1f, 0xbf, 0x1f, 0xbf, 0xff, 0xff, 
  0xff, 0x1f, 0x7f, 0x7f, 0x5f, 0x9f, 0xff, 0x3f, 0xbf, 0xff, 0x7f, 0xff, 0xff, 0x7f, 0xff, 0x7f, 
  0xff, 0x7f, 0x7f, 0xff, 0x3f, 0xff, 0x7f, 0xff, 0xbf, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xfd, 0xfd, 0xf0, 0xe4, 0xe6, 0xe6, 0xe6, 0xe6, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xf9, 0xfb, 
  0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc, 0xf9, 0xff, 0xfa, 0xfa, 0xf9, 0xfd, 
  0xff, 0xff, 0xff, 0xf8, 0xfb, 0xfe, 0xfb, 0xfb, 0xfb, 0xfc, 0xff, 0xff, 0xff, 0xf8, 0xff, 0xfc, 
  0xf9, 0xfe, 0xff, 0xff, 0xff, 0xf9, 0xfe, 0xfa, 0xfb, 0xff, 0xf8, 0xff, 0xf8, 0xfb, 0xff, 0xff, 
  0xff, 0xf8, 0xfb, 0xfb, 0xfb, 0xf8, 0xff, 0xf8, 0xff, 0xff, 0xfc, 0xfb, 0xfb, 0xf8, 0xff, 0xfe, 
  0xf9, 0xfe, 0xfc, 0xf9, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff 
};

// Define variables subject to change:
volatile bool buttonState = HIGH;
bool lastButtonState = HIGH;
int buttonPushCounter = 0;

PulseSensorPlayground pulseSensor;

// the setup function runs once when you press reset or power the board
void setup() {
  /*
     Use 115200 baud because that's what the Processing Sketch expects to read,
     and because that speed provides about 11 bytes per millisecond.

     If we used a slower baud rate, we'd likely write bytes faster than
     they can be transmitted, which would mess up the timing
     of readSensor() calls, which would make the pulse measurement
     not work properly.
  */
  Wire.begin();
  SeeedOled.init(); //initialize SeeedOLED display
  SeeedOled.clearDisplay(); //clear the screen and set start position to top left corner
  SeeedOled.drawBitmap((unsigned char*) myLogo,1024);   // 1024 = 128 Pixels * 64 Pixels / 8
  delay(3000);
  SeeedOled.clearDisplay();
  SeeedOled.setNormalDisplay(); //Set display to normal mode (i.e non-inverse mode)
  SeeedOled.setPageMode(); //Set addressing mode to Page Mode
  //SeeedOled.setTextXY(0,0); //Set the cursor to Xth Page, Yth Column  
  //SeeedOled.putString("Hello BME590!"); //Print the String
  
  Serial.begin(9600);
  pulseSensor.begin(); //initialize pulse sensor
  pulseSensor.analogInput(PULSE_INPUT); //initialize pin A0 as analog input pin for pulse sensor
  pulseSensor.setSerial(Serial);
  
  pinMode(interruptPin, INPUT); //initialize pin 2 as interrupt pin for pushbutton
  attachInterrupt(digitalPinToInterrupt(interruptPin), changestate, FALLING);
  
  pinMode(ledPin, OUTPUT); //initialize digital pin 3 as an output for LED.
  
}

int maxBPM = 0;
int BPM = 0;
unsigned long previousMillis = 0;

const long interval = 30000;

// the loop function runs over and over again forever
void loop() {
  unsigned long currentMillis = millis();
  int BPM = pulseSensor.getBeatsPerMinute();
  if (BPM>maxBPM){
    maxBPM = BPM;
  }
  if ((maxBPM>200)&&(currentMillis - previousMillis>=interval)) {
    maxBPM = 0;
    previousMillis = currentMillis;
  }
  
  switch (buttonPushCounter) {
    case 0:
      SeeedOled.clearDisplay();
      digitalWrite(ledPin, 0);
      break;
    case 1:
      analogWrite(ledPin, int(PWM_max/4));
      break;
    case 2:
      analogWrite(ledPin, int(PWM_max/2));
      break;
    case 3:
      digitalWrite(ledPin, PWM_max);
      break;
    case 4:
      digitalWrite(ledPin, PWM_max);
      delay(500);
      digitalWrite(ledPin, 0);
      delay(500);
      break;
    case 5:
      delay(20);
      SeeedOled.setTextXY(0,0);
      SeeedOled.putString("BPM:");
      SeeedOled.setTextXY(0,5);
      SeeedOled.putNumber(BPM);SeeedOled.putString("  ");
      SeeedOled.setTextXY(1,0);
      SeeedOled.putString("Max BPM:");
      SeeedOled.setTextXY(1,9);
      SeeedOled.putNumber(maxBPM);SeeedOled.putString("  ");
      //}
      break;
  }
}

// the if statement detects if the button has been pushed and changes the value of the state variable, buttonState
void changestate() {
  buttonState = !buttonState;
  buttonPushCounter ++;
  buttonPushCounter = buttonPushCounter % 6;
  Serial.println(buttonPushCounter);
}
